{extend name="template/base" /}
{block name="content"}
<div class="page-container">
  <div>
    <p>收货人地址信息：</p>
    <table class="table table-border table-bordered table-hover table-bg mt-20">
      <thead>
      <tr class="text-c">
        <td width="25%">收货人</td>
        <td width="25%">电话</td>
        <td width="25%">地址</td>
        <td width="25%">详细地址</td>
      </tr>
      </thead>
      <tbody>
      <tr class="text-c">
        <td class="f-14">{$address['name']}</td>
        <td class="f-14">{$address['mobile']}</td>
        <td class="f-14">{$address['address']} </td>
        <td class="f-14"> {$address['street']}</td>
      </tr>
      </tbody>
    </table>
  </div>
  <div>
    <p>订单信息：</p>
    {volist name="orderDetail" id="vo" empty=""}
    <table class="table table-border table-bordered table-hover table-bg mt-20">
      <thead>
      <tr class="text-c">
        <td>商品图片</td>
        <td>商品名</td>
          <td>价格</td>
          <td>下单时间</td>
        <td>商品规格</td>
        <td>购买数量</td>
          <td>运费</td>
        <td>状态</td>
        {if condition="$vo['after_sale_is'] eq 1"}
        <td>售后理由</td>
        <td>售后类型</td>
        <td>售后要求</td>
        <td>售后备注</td>
        <td>售后图片</td>
        <td>售后处理</td>
        {/if}
        <td>退货退款操作</td>
      </tr>
      </thead>
      <tbody>
      <tr class="text-c">
        <td class="f-14"><img width="30" height="30" src="{$vo['goods_detail']['main_image']}" /></td>
        <td class="f-14">{$vo['goods_detail']['name']}</td>
          <td class="f-14">{$vo['price']}</td>
          <td class="f-14">{$vo['create_time']|date="Y-m-d H:i:s",###}</td>

        <td class="f-14">{$vo['sku_val']}</td>
        <td class="f-14">{$vo['goods_num']}</td>
          <td class="f-14">{$vo['goods_detail']['postage']??'0'}</td>
          <td class="f-14">
             {php} if($vo['is_send']==2){
                echo "已收货";
             }else{
                echo "待收货";
              }{/php}
          </td>


        {if condition="$vo['after_sale_is'] eq 1 "}
        <td class="f-14">{$vo['after_sale_reson']}</td>
        <td class="f-14">{php}
                  if($vo['after_sale_type']==1){
          echo "换货";
                  }else if($vo['after_sale_type']==2){
          echo "维修";
                  }else if($vo['after_sale_type']==3){
          echo "退款/退货";
                  }
          {/php}</td>
        <td class="f-14">{$vo['after_sale_ask']}</td>
        <td class="f-14">{$vo['after_sale_remark']}</td>
        <td class="f-14">{php}
          if($vo['after_sale_pic']){
            $vo['after_sale_pic'] = explode(',',$vo['after_sale_pic']);
            foreach(   $vo['after_sale_pic'] as $vpic){
              echo "<img src='$vpic' width='50' height='50'>";
            }
          }
          {/php}</td>
        <td class="f-14">
          {if condition="$vo.after_sale_is eq 1"}
          <a href="javascript:;" onclick="afterHandle('{$vo[\'order_id\']}',{$vo['id']},{$vo['after_sale_type']})" class="btn btn-success radius mr-5 ml20"><i class="Hui-iconfont">  </i> 售后处理</a>
          {elseif  condition="$vo.after_sale_is eq 2" /}
          已处理
          {/if}
        </td>
        {/if}
        <td class="f-14">
          {if condition="$vo.is_return eq 1"}
          <a href="javascript:;" onclick="refundHandle('{$vo[\'order_id\']}',{$vo['id']},'yes')" class="btn btn-success radius mr-5 ml20"><i class="Hui-iconfont">  </i> 确定退款</a>
          <a href="javascript:;" onclick="refundHandle('{$vo[\'order_id\']}',{$vo['id']},'no')" class="btn btn-success radius mr-5 ml20"><i class="Hui-iconfont">  </i> 拒绝退款</a>
          {elseif  condition="$vo.is_return eq 2" /}
          已退款
          {/if}
        </td>
      </tr>

      </tbody>
    </table>
    <div>
      <form>
        <div class="mt20 mb20">
            <label class="ml20">快递名称:</label>
            <input type="text" placeholder="快递名称" name="logistics_name" value="{$vo['logistics_name']??''}" class="form_control w120 lh30 h30" >
            <label>快递单号:</label>
            <input type="text" placeholder="快递单号"  name="logistics_number"  value="{$vo['logistics_number']??''}" class="form_control w120 lh30 h30" >
          <a href="javascript:;" onclick="addPost(this,{$vo['id']})" class="btn btn-success radius mr-5 ml20"><i class="Hui-iconfont">  </i> 保存</a>
        </div>
      </form>
    </div>
    {/volist}
    <tr>
      <td>订单总价</td>
      <td>
        <input type="text" placeholder="订单总金额"  step="0.01" name="total_price"  value="{$vo['total_price']??''}" class="form_control w120 lh30 h30" >
        {if condition="$vo['pay_status'] eq 0"}
        <a href="javascript:;" onclick="editTotalPrice('{$vo[\'order_id\']}')" class="btn btn-success radius mr-5 ml20"><i class="Hui-iconfont">  </i> 修改总金额</a>
        {/if}
      </td>
    </tr>
  </div>
</div>
{/block}
{block name="script"}
<script>
        function  addPost(obj,id) {

            var logistics_name = $(obj).prev().prev().prev().val()
            var logistics_number = $(obj).prev('input').val()
            $.ajax({
                url:"{:url('order/addPost')}",
                type:'post',
                data:{'id':id,'logistics_name':logistics_name,'logistics_number':logistics_number},
                success:function (res) {
                    alert(res.msg)
                    document.location.reload()
                }
            })
        }
       function  editTotalPrice(order_id) {
            var totalPrice = $('input[name="total_price"]').val();
            if(totalPrice<=0){
                alert('订单金额不能小于0');
                return false;
            }
           if(order_id){
               $.ajax({
                   url:"{:url('order/editTotalPrice')}",
                   type:'post',
                   data:{'order_id':order_id,'totalPrice':totalPrice},
                   success:function (res) {
                       alert(res.msg)
                       document.location.relaod();
                   }
               })
           }
       }
       function refundHandle(order_id,id,flag) {
           if(order_id && id ){
               $.ajax({
                   url:"{:url('order/refund')}",
                   type:'post',
                   data:{'order_id':order_id,'id':id,'flag':flag},
                   success:function (res) {
                       alert(res.msg)
                       document.location.relaod();
                   }
               })
           }
       }
       function  afterHandle(order_id,id,after_sale_type) {
           if(order_id && id ){
               $.ajax({
                   url:"{:url('order/afterSaleHandle')}",
                   type:'post',
                   data:{'order_id':order_id,'id':id,'after_sale_type':after_sale_type},
                   success:function (res) {
                       alert(res.msg)
                       // document.location.relaod();
                   }
               })
           }
       }
</script>
{/block}